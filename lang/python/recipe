pkgname=python
pkgver=3.11.5
arcname=Python
arcext=tar.xz
arcurlbase=https://www.python.org/ftp/python/"$pkgver"/
run_deps="bzip2 expat gdbm libffi libxcrypt ncursesw openssl readline sqlite xz zlib"

# --with-system-ffi は渡さなくても yes になった。渡すと警告が出た：
# configure: WARNING: --with(out)-system-ffi is ignored on this platform

# --with-lto すると -g がつく（configure の LTOFLAGS を参照のこと）。
# テストを通すためらしい：
# https://bugs.python.org/issue30345#msg319614
# じゃあテストが終わったら strip してもいいかな。

# make install DESTDIR=... は同梱のパッケージ（pip や setuptools）に
# 関してはシステムのインストール状況を考慮してしまう。同梱のパッケージが
# システムにすでにインストールされていたら，バージョンが古ければそれを
# 削除しようとするし，バージョンが同じなら DESTDIR にはインストールして
# くれない。
# https://github.com/pypa/pip/issues/3063
#
# そこで同梱のパッケージは Fari での管理からはずす。--with-ensurepip=no
# を指定して，make install では同梱のパッケージをインストールさせない。
# make install 後に同梱のパッケージをインストールしたければ
# python3 -m ensurepip。
#
# configure の --with-ensurepip=... を make install 時に変更したければ
# make install ENSUREPIP=... でできるようだ。

_patch () {
    # ncursesw のヘッダファイルの探し場所を /usr/include/ncursesw から変更
    sed -i.orig 's|/usr\(/include/ncursesw\)|'"$prefix"'\1|' configure setup.py
}

_config () {
    ./configure \
        --prefix="$prefix" \
        --enable-shared \
        --enable-optimizations \
        --with-lto \
        --with-system-expat \
        --with-ensurepip=no \
        OPT="$optflags"
}

_build () {
    # SETUPTOOLS_USE_DISTUTILS=stdlib はいまビルドしている
    # Python が持っている distutils を使わせる。既定値
    # （=local）は，すでにどこかにインストールされている
    # setuptools に同梱の distutils を使う。その場合，その
    # distutils（と Python の標準ライブラリ？）に非互換性が
    # あるとうまく動かない。
    #
    # Python インストール中は =stdlib を最初から設定してくれて
    # いるべきのような気がするけどなあ。というかそもそも
    # Python のインストール中に外部にインストールされた
    # モジュールを使うべきでない気がする。
    #
    # * https://github.com/pypa/setuptools/issues/3007
    # * https://github.com/pypa/setuptools/pull/2896

    SETUPTOOLS_USE_DISTUTILS=stdlib make "$@"
}

_test () {
    SETUPTOOLS_USE_DISTUTILS=stdlib make test
}

_install () {
    # TEST_MODULES=no は Python 本体をテストするモジュールの
    # インストールを避けるため（Python ユーザがテストを書く
    # ためのモジュール，unittest や doctest はインストール
    # される）。configure の --disable-test-modules は
    # テストモジュールのビルドも回避されて make test が
    # 動かなくなるのでダメ。

    make install TEST_MODULES=no "$@"
}
